---
title: "ZWE_phase_2"
output: html_document
date: "2024-10-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The purpose of this notebook will be for generating the Phase 2 results for MIHPSA Zimbabwe

## Scenarios list

* Minimal
* Minimal + VMMC in 15-49 years old
* Minimal + Oral TDF/FTC PrEP
  * AGYW
  * FSW
  * SD couples
* Minimal + Dapirivine
  * AGYW
  * FSW
  * SD couples
* Minimal + Injectable PrEP
  * AGYW
  * FSW
  * SD couples
* Minimal + SBCC
* Minimal + condom mass media campaign

# Load libraries

```{r Load libraries}
library(tidyverse)
library(data.table)
library(magrittr)
library(devtools)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

# Import data

## Minimal scenario

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/Zimbabwe/ZWE_Phase2/Baseline-campaign_ZWE_MIHPSA_phase2_minimal-minimal___2024_10_14_23_09_28_872987"

sim.minimal <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'noprep',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed", 
                        "Newly.Tested.Positive", "Newly.Tested.Negative",
                        "HIVPositiveHIVTest","HIVNegativeHIVTest",
                        "Needs_PMTCT_Diagnostic_Test","NewlySymptomatic",
                        "Infected.CD4.Under.200..Not.On.ART.", "Infected.CD4.200.To.349..Not.On.ART.",
                        "Infected.CD4.350.To.499..Not.On.ART.", "Infected.CD4.500.Plus..Not.On.ART.",
                        "ReceivePrEP_HIGH", "Program_VMMC", "GaveBirth"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.Risk", "IsCircumcised"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```
## Join together and rescale

```{r}
sim.results.all <- sim.minimal

CENSUS_YEAR = 2010
ZWE_CENSUS_POP = 12696893 # WPP data

sim.results.pop.scaling <- sim.results.all %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = ZWE_CENSUS_POP/total.pop)

sim.results.all <- sim.results.all %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

# Flow Variables

## 

# Stock Variables

*Every half-year for stock variables

## HIV Prevalence

```{r}
p1 <- sim.results.all %>% 
  filter(Age >=15, Age<50, Gender == 0) %>%
  filter(Year != ceiling(Year)) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(pop = sum(Population * pop.scaling.factor), 
            PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(prev = case_when(pop > 0 ~ PLHIV/pop,
                          pop == 0 ~ 0)) %>% 
  group_by(Year) %>% 
  summarize(HIVprev_M1549_M_sd = sd(prev), 
            HIVprev_M1549_M = mean(prev), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(
    HIVprev_M1549_95LL = lower_ci(HIVprev_M1549_M, HIVprev_M1549_M_sd/sqrt(nruns), nruns, conf_level = .95),
    HIVprev_M1549_95UL = upper_ci(HIVprev_M1549_M, HIVprev_M1549_M_sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(-HIVprev_M1549_M_sd)

# HIVprev_F1549_M
p2 <- sim.results.prep %>% 
  filter(Age >=15, Age<50, Gender == 1) %>% 
  group_by(Year, sim.id) %>% 
  summarize(pop = sum(Population * pop.scaling.factor), 
            PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(prev = case_when(pop > 0 ~ PLHIV/pop,
                          pop == 0 ~ 0)) %>% 
  group_by(Year) %>% 
  summarize(HIVprev_F1549_M_sd = sd(prev), 
            HIVprev_F1549_M = mean(prev), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(
    HIVprev_F1549_95LL = lower_ci(HIVprev_F1549_M, HIVprev_F1549_M_sd/sqrt(nruns), nruns, conf_level = .95),
    HIVprev_F1549_95UL = upper_ci(HIVprev_F1549_M, HIVprev_F1549_M_sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(-HIVprev_F1549_M_sd)

# HIVprev_A1549_M
p3 <- sim.results.prep %>% 
  filter(Age >=15, Age<50) %>% 
  group_by(Year, sim.id) %>% 
  summarize(pop = sum(Population * pop.scaling.factor), 
            PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(prev = case_when(pop > 0 ~ PLHIV/pop,
                          pop == 0 ~ 0)) %>% 
  group_by(Year) %>% 
  summarize(HIVprev_A1549_M_sd = sd(prev), 
            HIVprev_A1549_M = mean(prev), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(
    HIVprev_A1549_95LL = lower_ci(HIVprev_A1549_M, HIVprev_A1549_M_sd/sqrt(nruns), nruns, conf_level = .95),
    HIVprev_A1549_95UL = upper_ci(HIVprev_A1549_M, HIVprev_A1549_M_sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(-HIVprev_A1549_M_sd)

# HIVprev_F1524_M
p4 <- sim.results.prep %>% 
  filter(Age >=15, Age<25, Gender == 1) %>% 
  group_by(Year, sim.id) %>% 
  summarize(pop = sum(Population * pop.scaling.factor), 
            PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(prev = case_when(pop > 0 ~ PLHIV/pop,
                          pop == 0 ~ 0)) %>% 
  group_by(Year) %>% 
  summarize(HIVprev_F1524_M_sd = sd(prev), 
            HIVprev_F1524_M = mean(prev), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(
    HIVprev_F1524_95LL = lower_ci(HIVprev_F1524_M, HIVprev_F1524_M_sd/sqrt(nruns), nruns, conf_level = .95),
    HIVprev_F1524_95UL = upper_ci(HIVprev_F1524_M, HIVprev_F1524_M_sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(-HIVprev_F1524_M_sd)

# HIVprev_FSW1599_M
p5 <- sim.results.prep %>% 
  filter(Age >=15, Gender == 1, IP_Key.Risk == "HIGH") %>% 
  group_by(Year, sim.id) %>% 
  summarize(pop = sum(Population * pop.scaling.factor), 
            PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(prev = case_when(pop > 0 ~ PLHIV/pop,
                          pop == 0 ~ 0)) %>% 
  group_by(Year) %>% 
  summarize(HIVprev_FSW1599_M_sd = sd(prev), 
            HIVprev_FSW1599_M = mean(prev), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(
    HIVprev_FSW1599_95LL = lower_ci(HIVprev_FSW1599_M, HIVprev_FSW1599_M_sd/sqrt(nruns), nruns, conf_level = .95),
    HIVprev_FSW1599_95UL = upper_ci(HIVprev_FSW1599_M, HIVprev_FSW1599_M_sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(-HIVprev_FSW1599_M_sd)

HIVprev <- merge(p1, p2, by = 'Year') %>% 
  merge(p3, by = 'Year') %>% 
  merge(p4, by = 'Year') %>%
  merge(p5, by = 'Year') %>%
  mutate(Year = floor(Year)) 
```

